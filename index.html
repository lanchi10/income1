<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מעקב הכנסות חודשיות - גרסה מתקדמת</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .income-item {
            transition: all 0.3s ease;
        }
        
        .income-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .edit-mode {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
        }
        
        @media print {
            body { 
                background: white !important; 
                font-size: 12px;
            }
            .no-print { display: none !important; }
            .glass-effect { 
                background: white !important; 
                backdrop-filter: none !important;
                border: 1px solid #ccc !important;
            }
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto">
        <!-- כותרת ראשית -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">
                <i class="fas fa-chart-line ml-2"></i>
                מעקב הכנסות חודשיות
            </h1>
            <p class="text-white text-lg opacity-80">ניהול מתקדם עם יכולות עריכה מלאות</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- עמודה שמאלית - הזנת נתונים -->
            <div class="lg:col-span-1">
                <!-- הגדרות מקורות הכנסה -->
                <div class="glass-effect rounded-xl p-6 mb-6">
                    <h2 class="text-xl font-semibold text-white mb-4">
                        <i class="fas fa-cog ml-2"></i>
                        הגדרות מקורות הכנסה
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-white text-sm mb-1">מקור 1:</label>
                            <input type="text" id="source1Name" value="טיפולים פרטיים" 
                                   class="w-full p-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30 focus:border-white/50 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-white text-sm mb-1">מקור 2:</label>
                            <input type="text" id="source2Name" value="גן תל השומר" 
                                   class="w-full p-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30 focus:border-white/50 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-white text-sm mb-1">מקור 3:</label>
                            <input type="text" id="source3Name" value="שונות" 
                                   class="w-full p-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30 focus:border-white/50 focus:outline-none">
                        </div>
                    </div>
                </div>

                <!-- הוספת הכנסה חדשה -->
                <div class="glass-effect rounded-xl p-6">
                    <h2 class="text-xl font-semibold text-white mb-4">
                        <i class="fas fa-plus-circle ml-2"></i>
                        הוספת הכנסה חדשה
                    </h2>
                    <form id="incomeForm" class="space-y-4">
                        <div>
                            <label class="block text-white text-sm mb-1">תאריך:</label>
                            <input type="date" id="incomeDate" required
                                   class="w-full p-2 rounded-lg bg-white/20 text-white border border-white/30 focus:border-white/50 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-white text-sm mb-1">מקור הכנסה:</label>
                            <select id="incomeSource" required
                                    class="w-full p-2 rounded-lg bg-white/20 text-white border border-white/30 focus:border-white/50 focus:outline-none">
                                <option value="">בחר מקור</option>
                                <option value="source1">טיפולים פרטיים</option>
                                <option value="source2">גן תל השומר</option>
                                <option value="source3">שונות</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-white text-sm mb-1">סכום (₪):</label>
                            <input type="number" id="incomeAmount" step="0.01" required
                                   class="w-full p-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30 focus:border-white/50 focus:outline-none"
                                   placeholder="0.00">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="isFixed" class="ml-2">
                            <label for="isFixed" class="text-white text-sm">הכנסה קבועה</label>
                        </div>
                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                            <i class="fas fa-save ml-2"></i>
                            הוסף הכנסה
                        </button>
                    </form>
                </div>
            </div>

            <!-- עמודה אמצעית ושמאלית - תצוגת נתונים -->
            <div class="lg:col-span-2">
                <!-- טאבים -->
                <div class="glass-effect rounded-xl mb-6">
                    <div class="flex bg-white/10 rounded-t-xl">
                        <button class="tab-button flex-1 py-3 px-4 text-white font-semibold rounded-tr-xl transition duration-300 active" data-tab="monthly">
                            <i class="fas fa-calendar-month ml-2"></i>
                            דוח חודשי
                        </button>
                        <button class="tab-button flex-1 py-3 px-4 text-white font-semibold transition duration-300" data-tab="yearly">
                            <i class="fas fa-calendar-year ml-2"></i>
                            דוח שנתי
                        </button>
                        <button class="tab-button flex-1 py-3 px-4 text-white font-semibold rounded-tl-xl transition duration-300" data-tab="list">
                            <i class="fas fa-list ml-2"></i>
                            רשימת הכנסות
                        </button>
                    </div>
                </div>

                <!-- תוכן הטאבים -->
                <div id="monthlyTab" class="tab-content">
                    <div class="glass-effect rounded-xl p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">
                                <i class="fas fa-calendar-month ml-2"></i>
                                דוח חודשי
                            </h3>
                            <select id="monthSelect" class="p-2 rounded-lg bg-white/20 text-white border border-white/30 focus:outline-none">
                            </select>
                        </div>
                        <div id="monthlyStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        </div>
                        <div class="bg-white/10 rounded-lg p-4" style="height: 300px;">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="yearlyTab" class="tab-content hidden">
                    <div class="glass-effect rounded-xl p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">
                                <i class="fas fa-calendar-year ml-2"></i>
                                דוח שנתי
                            </h3>
                            <select id="yearSelect" class="p-2 rounded-lg bg-white/20 text-white border border-white/30 focus:outline-none">
                            </select>
                        </div>
                        <div id="yearlyStats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        </div>
                        <div class="bg-white/10 rounded-lg p-4" style="height: 400px;">
                            <canvas id="yearlyChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="listTab" class="tab-content hidden">
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">
                                <i class="fas fa-list ml-2"></i>
                                רשימת הכנסות (ניתנות לעריכה)
                            </h3>
                            <div class="flex gap-2">
                                <select id="filterSource" class="p-2 rounded-lg bg-white/20 text-white border border-white/30 focus:outline-none text-sm">
                                    <option value="">כל המקורות</option>
                                    <option value="source1">טיפולים פרטיים</option>
                                    <option value="source2">גן תל השומר</option>
                                    <option value="source3">שונות</option>
                                </select>
                                <select id="filterMonth" class="p-2 rounded-lg bg-white/20 text-white border border-white/30 focus:outline-none text-sm">
                                    <option value="">כל החודשים</option>
                                </select>
                            </div>
                        </div>
                        <div id="incomeList" class="space-y-3 max-h-96 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- סטטיסטיקות כלליות -->
        <div class="glass-effect rounded-xl p-6 mt-6">
            <h3 class="text-xl font-semibold text-white mb-4">
                <i class="fas fa-chart-bar ml-2"></i>
                סטטיסטיקות כלליות
            </h3>
            <div id="generalStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            </div>
        </div>
    </div>

    <!-- מודל עריכה -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 no-print">
        <div class="bg-white rounded-xl p-6 m-4 max-w-md w-full" dir="rtl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">עריכת הכנסה</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm mb-1">תאריך:</label>
                    <input type="date" id="editDate" required class="w-full p-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm mb-1">מקור הכנסה:</label>
                    <select id="editSource" required class="w-full p-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="source1">טיפולים פרטיים</option>
                        <option value="source2">גן תל השומר</option>
                        <option value="source3">שונות</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm mb-1">סכום (₪):</label>
                    <input type="number" id="editAmount" step="0.01" required class="w-full p-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="editFixed" class="ml-2">
                    <label for="editFixed" class="text-gray-700 text-sm">הכנסה קבועה</label>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                        <i class="fas fa-save ml-2"></i>
                        שמור שינויים
                    </button>
                    <button type="button" id="cancelEdit" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                        <i class="fas fa-times ml-2"></i>
                        ביטול
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class IncomeTracker {
            constructor() {
                this.incomes = JSON.parse(localStorage.getItem('incomes')) || [];
                this.sourceNames = JSON.parse(localStorage.getItem('sourceNames')) || {
                    source1: 'טיפולים פרטיים',
                    source2: 'גן תל השומר',
                    source3: 'שונות'
                };
                this.editingId = null;
                this.monthlyChart = null;
                this.yearlyChart = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadSourceNames();
                this.setDefaultDate();
                this.populateSelects();
                this.showTab('monthly');
                this.updateDisplay();
            }

            setupEventListeners() {
                // טופס הוספת הכנסה
                document.getElementById('incomeForm').addEventListener('submit', (e) => this.addIncome(e));
                
                // שינוי שמות מקורות
                ['source1Name', 'source2Name', 'source3Name'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => this.updateSourceNames());
                });

                // טאבים
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.addEventListener('click', (e) => this.showTab(e.target.dataset.tab));
                });

                // בחירת חודש/שנה
                document.getElementById('monthSelect').addEventListener('change', () => this.updateMonthlyDisplay());
                document.getElementById('yearSelect').addEventListener('change', () => this.updateYearlyDisplay());

                // מסננים
                document.getElementById('filterSource').addEventListener('change', () => this.updateIncomeList());
                document.getElementById('filterMonth').addEventListener('change', () => this.updateIncomeList());

                // מודל עריכה
                document.getElementById('closeModal').addEventListener('click', () => this.closeEditModal());
                document.getElementById('cancelEdit').addEventListener('click', () => this.closeEditModal());
                document.getElementById('editForm').addEventListener('submit', (e) => this.saveEdit(e));
                document.getElementById('editModal').addEventListener('click', (e) => {
                    if (e.target.id === 'editModal') this.closeEditModal();
                });
            }

            loadSourceNames() {
                document.getElementById('source1Name').value = this.sourceNames.source1;
                document.getElementById('source2Name').value = this.sourceNames.source2;
                document.getElementById('source3Name').value = this.sourceNames.source3;
                this.updateSourceOptions();
            }

            updateSourceNames() {
                this.sourceNames = {
                    source1: document.getElementById('source1Name').value,
                    source2: document.getElementById('source2Name').value,
                    source3: document.getElementById('source3Name').value
                };
                localStorage.setItem('sourceNames', JSON.stringify(this.sourceNames));
                this.updateSourceOptions();
                this.updateDisplay();
            }

            updateSourceOptions() {
                const selects = ['incomeSource', 'editSource', 'filterSource'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (selectId === 'filterSource') {
                        select.innerHTML = '<option value="">כל המקורות</option>';
                    } else if (selectId === 'incomeSource') {
                        select.innerHTML = '<option value="">בחר מקור</option>';
                    }
                    
                    if (selectId !== 'incomeSource' || selectId === 'incomeSource') {
                        select.innerHTML += `
                            <option value="source1">${this.sourceNames.source1}</option>
                            <option value="source2">${this.sourceNames.source2}</option>
                            <option value="source3">${this.sourceNames.source3}</option>
                        `;
                    }
                });
            }

            setDefaultDate() {
                document.getElementById('incomeDate').valueAsDate = new Date();
            }

            populateSelects() {
                // חודשים
                const monthNames = [
                    'ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
                    'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'
                ];
                
                const monthSelect = document.getElementById('monthSelect');
                const filterMonth = document.getElementById('filterMonth');
                const currentDate = new Date();
                
                monthSelect.innerHTML = '';
                filterMonth.innerHTML = '<option value="">כל החודשים</option>';
                
                for (let year = currentDate.getFullYear() - 2; year <= currentDate.getFullYear() + 1; year++) {
                    for (let month = 0; month < 12; month++) {
                        const value = `${year}-${String(month + 1).padStart(2, '0')}`;
                        const text = `${monthNames[month]} ${year}`;
                        monthSelect.innerHTML += `<option value="${value}">${text}</option>`;
                        filterMonth.innerHTML += `<option value="${value}">${text}</option>`;
                    }
                }

                // בחירת החודש הנוכחי
                const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                monthSelect.value = currentMonth;

                // שנים
                const yearSelect = document.getElementById('yearSelect');
                yearSelect.innerHTML = '';
                for (let year = currentDate.getFullYear() - 2; year <= currentDate.getFullYear() + 1; year++) {
                    yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                }
                yearSelect.value = currentDate.getFullYear();
            }

            addIncome(e) {
                e.preventDefault();
                
                const income = {
                    id: Date.now(),
                    date: document.getElementById('incomeDate').value,
                    source: document.getElementById('incomeSource').value,
                    amount: parseFloat(document.getElementById('incomeAmount').value),
                    isFixed: document.getElementById('isFixed').checked
                };

                this.incomes.push(income);
                this.saveData();
                this.updateDisplay();
                e.target.reset();
                this.setDefaultDate();

                // הודעת הצלחה
                this.showNotification('ההכנסה נוספה בהצלחה!', 'success');
            }

            editIncome(id) {
                const income = this.incomes.find(i => i.id === id);
                if (!income) return;

                this.editingId = id;
                document.getElementById('editDate').value = income.date;
                document.getElementById('editSource').value = income.source;
                document.getElementById('editAmount').value = income.amount;
                document.getElementById('editFixed').checked = income.isFixed;

                document.getElementById('editModal').classList.remove('hidden');
                document.getElementById('editModal').classList.add('flex');
            }

            saveEdit(e) {
                e.preventDefault();
                
                const income = this.incomes.find(i => i.id === this.editingId);
                if (!income) return;

                income.date = document.getElementById('editDate').value;
                income.source = document.getElementById('editSource').value;
                income.amount = parseFloat(document.getElementById('editAmount').value);
                income.isFixed = document.getElementById('editFixed').checked;

                this.saveData();
                this.updateDisplay();
                this.closeEditModal();
                this.showNotification('ההכנסה עודכנה בהצלחה!', 'success');
            }

            deleteIncome(id) {
                if (confirm('האם אתה בטוח שברצונך למחוק הכנסה זו?')) {
                    this.incomes = this.incomes.filter(i => i.id !== id);
                    this.saveData();
                    this.updateDisplay();
                    this.showNotification('ההכנסה נמחקה בהצלחה!', 'success');
                }
            }

            closeEditModal() {
                document.getElementById('editModal').classList.add('hidden');
                document.getElementById('editModal').classList.remove('flex');
                this.editingId = null;
            }

            showTab(tabName) {
                // הסתרת כל הטאבים
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });

                // הסרת אקטיב מכל הכפתורים
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active', 'bg-white/20');
                });

                // הצגת הטאב הנבחר
                document.getElementById(`${tabName}Tab`).classList.remove('hidden');
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active', 'bg-white/20');

                // עדכון התצוגה בהתאם
                if (tabName === 'monthly') {
                    this.updateMonthlyDisplay();
                } else if (tabName === 'yearly') {
                    this.updateYearlyDisplay();
                } else if (tabName === 'list') {
                    this.updateIncomeList();
                }
            }

            updateDisplay() {
                this.updateMonthlyDisplay();
                this.updateYearlyDisplay();
                this.updateIncomeList();
                this.updateGeneralStats();
            }

            updateMonthlyDisplay() {
                const selectedMonth = document.getElementById('monthSelect').value;
                const [year, month] = selectedMonth.split('-');
                
                const monthlyIncomes = this.incomes.filter(income => {
                    const incomeDate = new Date(income.date);
                    return incomeDate.getFullYear() == year && (incomeDate.getMonth() + 1) == parseInt(month);
                });

                // סטטיסטיקות חודשיות
                const stats = this.calculateMonthlyStats(monthlyIncomes);
                this.displayMonthlyStats(stats);

                // גרף חודשי
                this.displayMonthlyChart(monthlyIncomes);
            }

            calculateMonthlyStats(incomes) {
                const stats = {
                    total: 0,
                    fixed: 0,
                    variable: 0,
                    bySource: { source1: 0, source2: 0, source3: 0 }
                };

                incomes.forEach(income => {
                    stats.total += income.amount;
                    if (income.isFixed) {
                        stats.fixed += income.amount;
                    } else {
                        stats.variable += income.amount;
                    }
                    stats.bySource[income.source] += income.amount;
                });

                return stats;
            }

            displayMonthlyStats(stats) {
                const container = document.getElementById('monthlyStats');
                container.innerHTML = `
                    <div class="bg-gradient-to-r from-green-400 to-green-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">סה"כ הכנסות</p>
                                <p class="text-2xl font-bold">₪${stats.total.toLocaleString()}</p>
                            </div>
                            <i class="fas fa-coins text-3xl opacity-60"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">הכנסות קבועות</p>
                                <p class="text-2xl font-bold">₪${stats.fixed.toLocaleString()}</p>
                            </div>
                            <i class="fas fa-anchor text-3xl opacity-60"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-400 to-purple-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">הכנסות משתנות</p>
                                <p class="text-2xl font-bold">₪${stats.variable.toLocaleString()}</p>
                            </div>
                            <i class="fas fa-chart-line text-3xl opacity-60"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-orange-400 to-orange-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">מקור עיקרי</p>
                                <p class="text-lg font-bold">${this.getTopSource(stats.bySource)}</p>
                            </div>
                            <i class="fas fa-star text-3xl opacity-60"></i>
                        </div>
                    </div>
                `;
            }

            displayMonthlyChart(incomes) {
                const ctx = document.getElementById('monthlyChart');
                
                if (this.monthlyChart) {
                    this.monthlyChart.destroy();
                }

                const sourceData = {
                    source1: 0,
                    source2: 0,
                    source3: 0
                };

                incomes.forEach(income => {
                    sourceData[income.source] += income.amount;
                });

                this.monthlyChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [this.sourceNames.source1, this.sourceNames.source2, this.sourceNames.source3],
                        datasets: [{
                            data: [sourceData.source1, sourceData.source2, sourceData.source3],
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(249, 115, 22, 0.8)'
                            ],
                            borderColor: [
                                'rgba(59, 130, 246, 1)',
                                'rgba(16, 185, 129, 1)',
                                'rgba(249, 115, 22, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'white',
                                    padding: 20,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ₪' + context.parsed.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            updateYearlyDisplay() {
                const selectedYear = parseInt(document.getElementById('yearSelect').value);
                
                const yearlyIncomes = this.incomes.filter(income => {
                    const incomeDate = new Date(income.date);
                    return incomeDate.getFullYear() === selectedYear;
                });

                // סטטיסטיקות שנתיות
                const stats = this.calculateYearlyStats(yearlyIncomes);
                this.displayYearlyStats(stats, selectedYear);

                // גרף שנתי
                this.displayYearlyChart(yearlyIncomes);
            }

            calculateYearlyStats(incomes) {
                const stats = {
                    total: 0,
                    average: 0,
                    months: 0,
                    byMonth: Array(12).fill(0)
                };

                const monthsWithIncome = new Set();

                incomes.forEach(income => {
                    stats.total += income.amount;
                    const month = new Date(income.date).getMonth();
                    stats.byMonth[month] += income.amount;
                    monthsWithIncome.add(month);
                });

                stats.months = monthsWithIncome.size;
                stats.average = stats.months > 0 ? stats.total / stats.months : 0;

                return stats;
            }

            displayYearlyStats(stats, year) {
                const container = document.getElementById('yearlyStats');
                container.innerHTML = `
                    <div class="bg-gradient-to-r from-indigo-400 to-indigo-600 rounded-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">סה"כ שנתי (${year})</p>
                                <p class="text-3xl font-bold">₪${stats.total.toLocaleString()}</p>
                            </div>
                            <i class="fas fa-calendar-year text-4xl opacity-60"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-teal-400 to-teal-600 rounded-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">ממוצע חודשי</p>
                                <p class="text-3xl font-bold">₪${stats.average.toLocaleString()}</p>
                            </div>
                            <i class="fas fa-chart-bar text-4xl opacity-60"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-pink-400 to-pink-600 rounded-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">חודשים פעילים</p>
                                <p class="text-3xl font-bold">${stats.months}/12</p>
                            </div>
                            <i class="fas fa-calendar-check text-4xl opacity-60"></i>
                        </div>
                    </div>
                `;
            }

            displayYearlyChart(incomes) {
                const ctx = document.getElementById('yearlyChart');
                
                if (this.yearlyChart) {
                    this.yearlyChart.destroy();
                }

                const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
                const monthlyData = Array(12).fill(0);

                incomes.forEach(income => {
                    const month = new Date(income.date).getMonth();
                    monthlyData[month] += income.amount;
                });

                this.yearlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: monthNames,
                        datasets: [{
                            label: 'הכנסות חודשיות',
                            data: monthlyData,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'white'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'white',
                                    callback: function(value) {
                                        return '₪' + value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'white'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            }

            updateIncomeList() {
                const filterSource = document.getElementById('filterSource').value;
                const filterMonth = document.getElementById('filterMonth').value;

                let filteredIncomes = this.incomes;

                if (filterSource) {
                    filteredIncomes = filteredIncomes.filter(income => income.source === filterSource);
                }

                if (filterMonth) {
                    const [year, month] = filterMonth.split('-');
                    filteredIncomes = filteredIncomes.filter(income => {
                        const incomeDate = new Date(income.date);
                        return incomeDate.getFullYear() == year && (incomeDate.getMonth() + 1) == parseInt(month);
                    });
                }

                // מיון לפי תאריך (החדשים ראשונים)
                filteredIncomes.sort((a, b) => new Date(b.date) - new Date(a.date));

                const container = document.getElementById('incomeList');
                if (filteredIncomes.length === 0) {
                    container.innerHTML = '<div class="text-center text-white/70 py-8">אין הכנסות להצגה</div>';
                    return;
                }

                container.innerHTML = filteredIncomes.map(income => `
                    <div class="income-item bg-white/10 rounded-lg p-4 border border-white/20" data-id="${income.id}">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="bg-blue-500 text-white px-2 py-1 rounded text-sm">
                                        ${this.sourceNames[income.source]}
                                    </span>
                                    ${income.isFixed ? '<span class="bg-green-500 text-white px-2 py-1 rounded text-sm"><i class="fas fa-anchor"></i> קבוע</span>' : ''}
                                    <span class="text-white/70 text-sm">${new Date(income.date).toLocaleDateString('he-IL')}</span>
                                </div>
                                <div class="text-white text-xl font-semibold">₪${income.amount.toLocaleString()}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="tracker.editIncome(${income.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-lg transition duration-300" title="ערוך">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="tracker.deleteIncome(${income.id})" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition duration-300" title="מחק">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updateGeneralStats() {
                const totalIncomes = this.incomes.reduce((sum, income) => sum + income.amount, 0);
                const totalFixed = this.incomes.filter(i => i.isFixed).reduce((sum, income) => sum + income.amount, 0);
                const totalVariable = totalIncomes - totalFixed;
                const avgMonthly = this.calculateAverageMonthly();

                const container = document.getElementById('generalStats');
                container.innerHTML = `
                    <div class="bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">סה"כ כל הזמנים</p>
                                <p class="text-3xl font-bold">₪${totalIncomes.toLocaleString()}</p>
                            </div>
                            <i class="fas fa-globe text-4xl opacity-60"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-cyan-400 to-cyan-600 rounded-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">ממוצע חודשי כללי</p>
                                <p class="text-3xl font-bold">₪${avgMonthly.toLocaleString()}</p>
                            </div>
                            <i class="fas fa-calculator text-4xl opacity-60"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-violet-400 to-violet-600 rounded-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">סה"כ הכנסות קבועות</p>
                                <p class="text-3xl font-bold">₪${totalFixed.toLocaleString()}</p>
                            </div>
                            <i class="fas fa-lock text-4xl opacity-60"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-rose-400 to-rose-600 rounded-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-80">סה"כ הכנסות משתנות</p>
                                <p class="text-3xl font-bold">₪${totalVariable.toLocaleString()}</p>
                            </div>
                            <i class="fas fa-arrows-alt text-4xl opacity-60"></i>
                        </div>
                    </div>
                `;
            }

            calculateAverageMonthly() {
                if (this.incomes.length === 0) return 0;

                const months = new Set();
                this.incomes.forEach(income => {
                    const date = new Date(income.date);
                    months.add(`${date.getFullYear()}-${date.getMonth()}`);
                });

                const totalAmount = this.incomes.reduce((sum, income) => sum + income.amount, 0);
                return months.size > 0 ? Math.round(totalAmount / months.size) : 0;
            }

            getTopSource(bySource) {
                const sources = Object.entries(bySource);
                const topSource = sources.reduce((max, current) => 
                    current[1] > max[1] ? current : max
                );
                return this.sourceNames[topSource[0]];
            }

            saveData() {
                localStorage.setItem('incomes', JSON.stringify(this.incomes));
            }

            showNotification(message, type = 'success') {
                // יצירת הודעה זמנית
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
                    type === 'success' ? 'bg-green-500' : 'bg-red-500'
                }`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // אתחול האפליקציה
        const tracker = new IncomeTracker();
    </script>
</body>
</html>
